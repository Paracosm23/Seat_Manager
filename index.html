<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Seating Layout Editor - Extended Features</title>
  <style>
    /* ---------- Basic Dark Mode Styling ---------- */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #e0e0e0;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    /* ---------- Sidebar & Hamburger ---------- */
    #toggle-sidebar-btn {
      position: fixed;
      top: 10px;
      left: 10px;
      background: none;
      border: none;
      font-size: 24px;
      color: #e0e0e0;
      cursor: pointer;
      z-index: 2000;
    }
    #sidebar {
      width: 300px;
      background-color: #1e1e1e;
      border-right: 1px solid #555;
      padding: 10px;
      box-sizing: border-box;
      overflow-y: auto;
      transition: width 0.3s ease;
      position: relative;
      margin-left: 40px;
    }
    #sidebar.collapsed {
      width: 50px;
    }
    #sidebar.collapsed .tab-buttons,
    #sidebar.collapsed .tab-content {
      display: none;
    }
    /* ---------- Tabs ---------- */
    .tab-buttons {
      display: flex;
      margin-bottom: 10px;
    }
    .tab-button {
      flex: 1;
      padding: 6px;
      background-color: #333;
      border: 1px solid #555;
      cursor: pointer;
      text-align: center;
      font-size: 14px;
    }
    .tab-button.active {
      background-color: #444;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    /* ---------- Main Container ---------- */
    #main-container {
      flex-grow: 1;
      position: relative;
      padding: 10px;
      overflow: auto;
      background-color: #181818;
    }
    #background-container {
      position: relative;
      width: 800px;
      height: 600px;
      border: 1px solid #555;
      background-size: cover;
      background-position: center;
      margin: 0 auto;
    }
    /* ---------- Auditorium Layout Overlay ---------- */
    #seat-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none; /* Divisions are pointer-events: auto */
    }
    /* ---------- Divisions (Final Boxes) ---------- */
    .division {
      position: absolute;
      border: 2px solid #888;
      background-color: #1e1e1e;
      pointer-events: auto;
      box-sizing: border-box;
    }
    .division .header {
      background-color: #333;
      padding: 4px;
      font-size: 14px;
      cursor: move; /* for dragging the division */
    }
    /* ---------- Rows & Chairs ---------- */
    .seat-row-container {
      margin: 5px;
      border: 1px dashed #555;
      padding: 5px;
      background-color: #2a2a2a;
    }
    /* ---------- Buttons & Inputs ---------- */
    button, input[type="file"], input[type="number"], input[type="text"] {
      background-color: #333;
      color: #e0e0e0;
      border: 1px solid #555;
      padding: 4px;
      font-size: 12px;
      margin: 4px 0;
    }
    #finalize-btn {
      margin-top: 10px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      background-color: #333;
      border: 1px solid #555;
      color: #e0e0e0;
    }
    /* ---------- Row Config Boxes ---------- */
    .row-config {
      border: 1px dashed #555;
      padding: 4px;
      margin: 4px 0;
      background-color: #1a1a1a;
    }
    /* Example styling for "selected" row config (for copy/paste) */
    .row-config.selected {
      outline: 2px solid #ff0;
    }
  </style>
</head>
<body>
  <!-- Hamburger to collapse sidebar -->
  <button id="toggle-sidebar-btn">â˜°</button>
  
  <!-- Sidebar -->
  <div id="sidebar">
    <div class="tab-buttons">
      <div class="tab-button active" data-tab="upload-tab">Upload</div>
      <div class="tab-button" data-tab="divisions-tab">Divisions</div>
      <div class="tab-button" data-tab="groups-tab">Groups</div>
    </div>
    
    <!-- UPLOAD TAB -->
    <div id="upload-tab" class="tab-content active">
      <h3>Upload &amp; Config</h3>
      <label>Upload Background:</label><br>
      <input type="file" id="bg-upload" accept="image/*"><br>
      <p>Scroll over background to zoom</p>
      <hr>
      <label>Upload Division Config (JSON):</label><br>
      <input type="file" id="upload-config-file" accept="application/json"><br>
      <button id="download-config-btn">Download Config</button>
    </div>
    
    <!-- DIVISIONS TAB -->
    <div id="divisions-tab" class="tab-content">
      <h3>Division Config</h3>
      <button id="add-division-btn">Add Division</button>
      <div id="division-list"></div>
    </div>
    
    <!-- GROUPS TAB -->
    <div id="groups-tab" class="tab-content">
      <h3>Groups</h3>
      <p>(Group assignment controls go here.)</p>
    </div>
  </div>
  
  <!-- Main Container -->
  <div id="main-container">
    <h2>Main Area</h2>
    <div id="background-container">
      <div id="seat-overlay"></div>
    </div>
    <button id="finalize-btn">Finalize Layout &amp; Proceed to Groups</button>
  </div>
  
  <script>
    /************************************************
     * 1) Basic Setup & State
     ************************************************/
    let auditoriumData = { divisions: [] }; 
    // We store the entire layout in memory. We'll sync to localStorage automatically.
    // For undo/redo we keep a simple history stack:
    let historyStack = [];
    // For copy/paste we store a "clipboard" of row or division config
    let clipboard = null;
    // For selection we store a reference to the "selected" row config element
    let selectedRowConfig = null;

    // Keyboard Shortcuts: Undo (Ctrl+Z), Copy (Ctrl+C), Paste (Ctrl+V)
    document.addEventListener('keydown', function(e) {
      // Check for OS-specific combos if needed
      const ctrlOrCmd = e.ctrlKey || e.metaKey;
      if (ctrlOrCmd && e.key.toLowerCase() === 'z') {
        e.preventDefault();
        undo();
      } else if (ctrlOrCmd && e.key.toLowerCase() === 'c') {
        e.preventDefault();
        copyRowConfig();
      } else if (ctrlOrCmd && e.key.toLowerCase() === 'v') {
        e.preventDefault();
        pasteRowConfig();
      }
    });

    /************************************************
     * 2) Local Storage & History
     ************************************************/
    function pushHistory() {
      // push a deep clone of auditoriumData
      const clone = JSON.parse(JSON.stringify(auditoriumData));
      historyStack.push(clone);
      if (historyStack.length > 50) {
        historyStack.shift(); // limit
      }
    }
    function undo() {
      if (historyStack.length === 0) {
        alert("Nothing to undo.");
        return;
      }
      const prevState = historyStack.pop();
      auditoriumData = prevState;
      // re-draw UI
      renderAll();
    }
    function saveToLocalStorage() {
      localStorage.setItem('auditoriumRoomLayout', JSON.stringify(auditoriumData));
    }
    function loadFromLocalStorage() {
      let stored = localStorage.getItem('auditoriumRoomLayout');
      if (stored) {
        auditoriumData = JSON.parse(stored);
      } else {
        auditoriumData = { divisions: [] };
      }
    }

    /************************************************
     * 3) Copy/Paste of Row Config
     ************************************************/
    function copyRowConfig() {
      if (!selectedRowConfig) {
        alert("No row config selected for copy.");
        return;
      }
      // read its data from dataset or a stored object
      let rowData = getRowDataFromConfigElement(selectedRowConfig);
      clipboard = rowData;
      alert("Row config copied.");
    }
    function pasteRowConfig() {
      if (!clipboard) {
        alert("Clipboard empty.");
        return;
      }
      // We'll paste the row config into the same division if possible
      // or just add it to the first division for demonstration
      if (auditoriumData.divisions.length === 0) {
        alert("No divisions exist to paste into.");
        return;
      }
      // For simplicity, paste into the first division
      auditoriumData.divisions[0].rows.push(JSON.parse(JSON.stringify(clipboard)));
      pushHistory();
      saveToLocalStorage();
      renderAll();
      alert("Pasted row config into first division.");
    }

    /************************************************
     * 4) Basic UI / Tabs
     ************************************************/
    document.getElementById('toggle-sidebar-btn').addEventListener('click', () => {
      document.getElementById('sidebar').classList.toggle('collapsed');
    });
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        // handled above
      });
    });

    /************************************************
     * 5) Background Upload & Zoom
     ************************************************/
    const bgContainer = document.getElementById('background-container');
    document.getElementById('bg-upload').addEventListener('change', function(e) {
      let file = e.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = function(ev) {
        bgContainer.style.backgroundImage = `url(${ev.target.result})`;
        localStorage.setItem('auditoriumBackgroundImage', ev.target.result);
      };
      reader.readAsDataURL(file);
    });
    // Zoom with scroll wheel
    bgContainer.addEventListener('wheel', function(e) {
      e.preventDefault();
      let currentSize = parseFloat(window.getComputedStyle(this).backgroundSize) || 100;
      if (e.deltaY < 0) {
        currentSize += 10;
      } else {
        currentSize -= 10;
        if (currentSize < 50) currentSize = 50;
      }
      this.style.backgroundSize = currentSize + "%";
    });

    /************************************************
     * 6) Download / Upload Division Config
     ************************************************/
    document.getElementById('download-config-btn').addEventListener('click', () => {
      let data = JSON.stringify(auditoriumData, null, 2);
      let blob = new Blob([data], { type: "application/json" });
      let url = URL.createObjectURL(blob);
      let a = document.createElement('a');
      a.href = url;
      a.download = "division-config.json";
      a.click();
      URL.revokeObjectURL(url);
    });
    // Upload config
    document.getElementById('upload-config-file').addEventListener('change', (e) => {
      let file = e.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = function(ev) {
        try {
          auditoriumData = JSON.parse(ev.target.result);
          pushHistory();
          saveToLocalStorage();
          renderAll();
          alert("Config uploaded & loaded.");
        } catch(err) {
          alert("Invalid JSON file.");
        }
      };
      reader.readAsText(file);
    });

    /************************************************
     * 7) Divisions UI in Sidebar
     ************************************************/
    const divisionList = document.getElementById('division-list');
    document.getElementById('add-division-btn').addEventListener('click', () => {
      let newDiv = { name: "New Division", rows: [] };
      auditoriumData.divisions.push(newDiv);
      pushHistory();
      saveToLocalStorage();
      renderAll();
    });

    function renderDivisionList() {
      divisionList.innerHTML = "";
      auditoriumData.divisions.forEach((divObj, divIndex) => {
        let divBox = document.createElement('div');
        divBox.style.border = "1px solid #888";
        divBox.style.padding = "6px";
        divBox.style.marginBottom = "6px";

        // Division name input
        let nameInput = document.createElement('input');
        nameInput.type = "text";
        nameInput.value = divObj.name;
        nameInput.addEventListener('input', () => {
          divObj.name = nameInput.value;
          pushHistory();
          saveToLocalStorage();
          renderAll();
        });
        divBox.appendChild(nameInput);

        // Delete division
        let delBtn = document.createElement('button');
        delBtn.textContent = "Delete";
        delBtn.addEventListener('click', () => {
          auditoriumData.divisions.splice(divIndex, 1);
          pushHistory();
          saveToLocalStorage();
          renderAll();
        });
        divBox.appendChild(delBtn);

        // Row list
        let rowContainer = document.createElement('div');
        rowContainer.style.marginLeft = "10px";
        divObj.rows.forEach((rowObj, rowIndex) => {
          let rowElem = renderRowConfigElement(divIndex, rowIndex);
          rowContainer.appendChild(rowElem);
        });
        divBox.appendChild(rowContainer);

        // Add new row button
        let addRowBtn = document.createElement('button');
        addRowBtn.textContent = "Add Row";
        addRowBtn.addEventListener('click', () => {
          let newRow = { chairs: 5, rotation: 0, height: 40, offset: 0, showName: true };
          divObj.rows.push(newRow);
          pushHistory();
          saveToLocalStorage();
          renderAll();
        });
        divBox.appendChild(addRowBtn);

        divisionList.appendChild(divBox);
      });
    }

    // Renders a row config UI element
    function renderRowConfigElement(divIndex, rowIndex) {
      let rowObj = auditoriumData.divisions[divIndex].rows[rowIndex];
      let rowDiv = document.createElement('div');
      rowDiv.classList.add('row-config');
      rowDiv.addEventListener('click', (e) => {
        // manage "selected" for copy/paste
        e.stopPropagation(); // so we don't trigger parent's click
        if (selectedRowConfig) {
          selectedRowConfig.classList.remove('selected');
        }
        selectedRowConfig = rowDiv;
        rowDiv.classList.add('selected');
      });

      // Chairs
      let chairsLabel = document.createElement('span');
      chairsLabel.textContent = "Chairs:";
      rowDiv.appendChild(chairsLabel);
      let chairsInput = document.createElement('input');
      chairsInput.type = "number";
      chairsInput.value = rowObj.chairs;
      chairsInput.min = 1;
      chairsInput.addEventListener('input', () => {
        rowObj.chairs = parseInt(chairsInput.value);
        pushHistory();
        saveToLocalStorage();
        renderAll();
      });
      rowDiv.appendChild(chairsInput);

      // Rotation
      let rotGroup = document.createElement('div');
      rotGroup.classList.add('param-group');
      let rotLabel = document.createElement('label');
      rotLabel.textContent = "Rotation:";
      rotGroup.appendChild(rotLabel);
      let rotSlider = document.createElement('input');
      rotSlider.type = "range";
      rotSlider.min = 0;
      rotSlider.max = 360;
      rotSlider.value = rowObj.rotation;
      rotGroup.appendChild(rotSlider);
      let rotNum = document.createElement('input');
      rotNum.type = "number";
      rotNum.min = 0;
      rotNum.max = 360;
      rotNum.value = rowObj.rotation;
      rotGroup.appendChild(rotNum);
      rotSlider.addEventListener('input', () => {
        rotNum.value = rotSlider.value;
        rowObj.rotation = parseFloat(rotSlider.value);
        pushHistory();
        saveToLocalStorage();
        renderAll();
      });
      rotNum.addEventListener('input', () => {
        rotSlider.value = rotNum.value;
        rowObj.rotation = parseFloat(rotNum.value);
        pushHistory();
        saveToLocalStorage();
        renderAll();
      });
      rowDiv.appendChild(rotGroup);

      // Height
      let heightGroup = document.createElement('div');
      heightGroup.classList.add('param-group');
      let heightLabel = document.createElement('label');
      heightLabel.textContent = "Height:";
      heightGroup.appendChild(heightLabel);
      let heightSlider = document.createElement('input');
      heightSlider.type = "range";
      heightSlider.min = 20;
      heightSlider.max = 100;
      heightSlider.value = rowObj.height;
      heightGroup.appendChild(heightSlider);
      let heightNum = document.createElement('input');
      heightNum.type = "number";
      heightNum.min = 20;
      heightNum.max = 100;
      heightNum.value = rowObj.height;
      heightGroup.appendChild(heightNum);
      heightSlider.addEventListener('input', () => {
        heightNum.value = heightSlider.value;
        rowObj.height = parseFloat(heightSlider.value);
        pushHistory();
        saveToLocalStorage();
        renderAll();
      });
      heightNum.addEventListener('input', () => {
        heightSlider.value = heightNum.value;
        rowObj.height = parseFloat(heightNum.value);
        pushHistory();
        saveToLocalStorage();
        renderAll();
      });
      rowDiv.appendChild(heightGroup);

      // Offset
      let offsetGroup = document.createElement('div');
      offsetGroup.classList.add('param-group');
      let offsetLabel = document.createElement('label');
      offsetLabel.textContent = "Offset:";
      offsetGroup.appendChild(offsetLabel);
      let offsetSlider = document.createElement('input');
      offsetSlider.type = "range";
      offsetSlider.min = 0;
      offsetSlider.max = 200;
      offsetSlider.value = rowObj.offset;
      offsetGroup.appendChild(offsetSlider);
      let offsetNum = document.createElement('input');
      offsetNum.type = "number";
      offsetNum.min = 0;
      offsetNum.max = 200;
      offsetNum.value = rowObj.offset;
      offsetGroup.appendChild(offsetNum);
      offsetSlider.addEventListener('input', () => {
        offsetNum.value = offsetSlider.value;
        rowObj.offset = parseFloat(offsetSlider.value);
        pushHistory();
        saveToLocalStorage();
        renderAll();
      });
      offsetNum.addEventListener('input', () => {
        offsetSlider.value = offsetNum.value;
        rowObj.offset = parseFloat(offsetNum.value);
        pushHistory();
        saveToLocalStorage();
        renderAll();
      });
      rowDiv.appendChild(offsetGroup);

      // Show Name
      let showNameGroup = document.createElement('div');
      showNameGroup.classList.add('showname-group');
      let showNameLabel = document.createElement('label');
      let chk = document.createElement('input');
      chk.type = "checkbox";
      chk.classList.add('showname-checkbox');
      chk.checked = rowObj.showName;
      showNameLabel.textContent = " Show Row Name";
      showNameLabel.prepend(chk);
      showNameGroup.appendChild(showNameLabel);
      chk.addEventListener('change', () => {
        rowObj.showName = chk.checked;
        pushHistory();
        saveToLocalStorage();
        renderAll();
      });
      rowDiv.appendChild(showNameGroup);

      // Delete row
      let delRowBtn = document.createElement('button');
      delRowBtn.textContent = "Delete Row";
      delRowBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        auditoriumData.divisions[divIndex].rows.splice(rowIndex, 1);
        pushHistory();
        saveToLocalStorage();
        renderAll();
      });
      rowDiv.appendChild(delRowBtn);

      return rowDiv;
    }

    function getRowDataFromConfigElement(elem) {
      // In a real app, weâ€™d store the rowâ€™s data in dataset or read from the global data structure
      // For demonstration, we do minimal approach: we find the row in the global data by searching
      // This is not super efficient, but works for small demos
      let allRowConfigs = document.querySelectorAll('.row-config');
      let index = Array.from(allRowConfigs).indexOf(elem);
      // We can attempt to find it by scanning the divisions
      let count = 0;
      for (let d of auditoriumData.divisions) {
        for (let r of d.rows) {
          if (count === index) return r;
          count++;
        }
      }
      return null; // not found
    }

    /************************************************
     * 8) Rendering the Final Divisions (in seat-overlay)
     ************************************************/
    function renderAll() {
      // Re-render the sidebar
      renderDivisionList();
      // Re-render the final divisions on seat-overlay
      let seatOverlay = document.getElementById('seat-overlay');
      seatOverlay.innerHTML = "";
      auditoriumData.divisions.forEach((divObj, dIndex) => {
        // Create a division element
        let divEl = document.createElement('div');
        divEl.classList.add('division');
        divEl.style.left = (50 + dIndex * 40) + "px";
        divEl.style.top = (50 + dIndex * 40) + "px";
        divEl.style.width = "250px";
        divEl.style.height = "200px";
        
        // Division header
        let header = document.createElement('div');
        header.classList.add('header');
        header.textContent = divObj.name;
        divEl.appendChild(header);
        makeDraggable(divEl, '.header');

        // seat rows
        divObj.rows.forEach((rowObj, rIndex) => {
          // Just a placeholder for demonstration
          let rowContainer = document.createElement('div');
          rowContainer.classList.add('seat-row-container');
          rowContainer.textContent = `Row: ${rIndex+1}, Chairs: ${rowObj.chairs}`;
          divEl.appendChild(rowContainer);
        });

        seatOverlay.appendChild(divEl);
      });
    }

    /************************************************
     * 9) Finalize & Startup
     ************************************************/
    document.getElementById('finalize-btn').addEventListener('click', () => {
      // Save final to localStorage
      saveToLocalStorage();
      alert("Layout finalized and saved! (Redirect to Groups if needed.)");
      // For demonstration, we do not actually navigate
    });

    function pushHistory() {
      // push a deep clone
      let clone = JSON.parse(JSON.stringify(auditoriumData));
      historyStack.push(clone);
      if (historyStack.length > 50) historyStack.shift();
    }
    function undo() {
      if (historyStack.length === 0) {
        alert("Nothing to undo.");
        return;
      }
      let prev = historyStack.pop();
      auditoriumData = prev;
      saveToLocalStorage();
      renderAll();
    }

    function saveToLocalStorage() {
      localStorage.setItem('auditoriumRoomLayout', JSON.stringify(auditoriumData));
    }
    function loadFromLocalStorage() {
      let stored = localStorage.getItem('auditoriumRoomLayout');
      if (stored) {
        auditoriumData = JSON.parse(stored);
      } else {
        auditoriumData = { divisions: [] };
      }
    }

    // On page load
    window.addEventListener('load', () => {
      loadFromLocalStorage();
      renderAll();
    });
  </script>
</body>
</html>
