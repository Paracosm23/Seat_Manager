<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Auditorium Layout Editor (Dark Mode)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #121212;
      color: #e0e0e0;
    }
    /* Overall editor container */
    #layout-editor {
      margin-top: 20px;
    }
    /* Division container styling */
    .division {
      border: 2px solid #888;
      padding: 10px;
      margin-bottom: 15px;
      background-color: #1e1e1e;
    }
    .division > .header {
      font-weight: bold;
      margin-bottom: 5px;
    }
    /* Subdivision container styling */
    .subdivision {
      border: 1px dashed #0077cc;
      padding: 10px;
      margin: 10px;
      background-color: #1e1e1e;
    }
    .subdivision > .header {
      font-weight: bold;
      margin-bottom: 5px;
    }
    /* Row configuration inside subdivision */
    .row-config {
      margin: 5px 0;
    }
    .rows-container {
      margin-top: 5px;
    }
    /* Row container styling */
    .seat-row-container {
      margin: 5px 0;
      border: 1px solid #555;
      padding: 5px;
      background-color: #1e1e1e;
    }
    .row-header {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
      gap: 5px;
    }
    .seat-row {
      display: flex;
    }
    /* Seat styling */
    .seat {
      width: 30px;
      height: 30px;
      border: 1px solid #999;
      margin-right: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      cursor: pointer;
      font-size: 0.8em;
      background-color: #2e2e2e;
      color: #e0e0e0;
    }
    /* Active seat styling - highlighting removed */
    .seat.active {
      /* No background highlight */
    }
    /* Button styling */
    button {
      margin: 2px 0;
      background-color: #333;
      color: #e0e0e0;
      border: 1px solid #555;
      padding: 5px 10px;
      cursor: pointer;
    }
    button:hover {
      background-color: #444;
    }
    input[type="text"],
    input[type="number"] {
      background-color: #333;
      border: 1px solid #555;
      color: #e0e0e0;
      padding: 2px 5px;
    }
  </style>
  <!-- Include html2canvas from a CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <h1>Auditorium Layout Editor (Dark Mode)</h1>
  <p>
    Build your room by adding Divisions. In each division, add a Subdivision and specify how many rows it should have.
    Then, for each row, set the number of chairs and select individual seats (or dragâ€“select them) or select the entire row.
    When you finalize the layout, a PNG image will be generated from the layout.
  </p>
  
  <!-- Global Controls -->
  <div id="controls">
    <button id="add-division-btn">Add Division</button>
  </div>
  
  <!-- Main Editor Container -->
  <div id="layout-editor"></div>
  
  <!-- Finalize Layout -->
  <button id="finalize-btn" style="margin-top:20px;">Finalize Layout &amp; Generate PNG</button>
  
  <script>
    // Global flag for drag selection
    let isDragging = false;
    document.addEventListener('mouseup', () => { isDragging = false; });
    
    // Toggle a seat's active state (internally tracked, but no visual highlight)
    function toggleSeat(seat) {
      if (seat.dataset.active === "false") {
        seat.dataset.active = "true";
        seat.classList.add('active');
      } else {
        seat.dataset.active = "false";
        seat.classList.remove('active');
      }
    }
    
    // Create a single seat element
    function createSeat(index) {
      const seat = document.createElement('div');
      seat.classList.add('seat');
      seat.textContent = index + 1;
      seat.dataset.active = "false";
      
      // Begin drag selection on mousedown
      seat.addEventListener('mousedown', (e) => {
        isDragging = true;
        toggleSeat(seat);
      });
      // If dragging and mouse hovers over a seat, toggle if not already active
      seat.addEventListener('mouseover', (e) => {
        if (isDragging && seat.dataset.active === "false") {
          toggleSeat(seat);
        }
      });
      // Allow a single click to toggle selection
      seat.addEventListener('click', (e) => {
        toggleSeat(seat);
      });
      return seat;
    }
    
    // Create a row container with controls for adjusting the number of chairs
    function createRow(seatCount) {
      const rowContainer = document.createElement('div');
      rowContainer.classList.add('seat-row-container');
      
      // Row header with an input for seat count and control buttons
      const header = document.createElement('div');
      header.classList.add('row-header');
      
      const label = document.createElement('span');
      label.textContent = "Chairs:";
      header.appendChild(label);
      
      const seatCountInput = document.createElement('input');
      seatCountInput.type = "number";
      seatCountInput.min = "1";
      seatCountInput.value = seatCount;
      seatCountInput.style.width = "50px";
      header.appendChild(seatCountInput);
      
      // Button to update the row (adjust number of chairs)
      const updateBtn = document.createElement('button');
      updateBtn.textContent = "Update Row";
      header.appendChild(updateBtn);
      
      // Button to toggle selection for the entire row
      const selectRowBtn = document.createElement('button');
      selectRowBtn.textContent = "Select Row";
      header.appendChild(selectRowBtn);
      
      rowContainer.appendChild(header);
      
      // Container to hold the seats
      const rowDiv = document.createElement('div');
      rowDiv.classList.add('seat-row');
      rowContainer.appendChild(rowDiv);
      
      // Render initial seats for this row
      function renderSeats(newSeatCount) {
        const currentCount = rowDiv.children.length;
        if (newSeatCount > currentCount) {
          // Add extra seats
          for (let i = currentCount; i < newSeatCount; i++) {
            const seat = createSeat(i);
            rowDiv.appendChild(seat);
          }
        } else if (newSeatCount < currentCount) {
          // Remove seats from the end
          for (let i = currentCount; i > newSeatCount; i--) {
            rowDiv.removeChild(rowDiv.lastChild);
          }
        }
      }
      
      // Create the initial seats
      for (let i = 0; i < seatCount; i++) {
        const seat = createSeat(i);
        rowDiv.appendChild(seat);
      }
      
      // Update Row button: change the number of seats based on input
      updateBtn.addEventListener('click', function() {
        const newCount = parseInt(seatCountInput.value);
        if (isNaN(newCount) || newCount < 1) {
          alert("Invalid seat count.");
          seatCountInput.value = rowDiv.children.length;
          return;
        }
        renderSeats(newCount);
      });
      
      // Select Row button: toggle selection for all seats in the row
      selectRowBtn.addEventListener('click', function() {
        const seats = rowDiv.querySelectorAll('.seat');
        const allSelected = Array.from(seats).every(seat => seat.dataset.active === "true");
        seats.forEach(seat => {
          if (allSelected) {
            seat.dataset.active = "false";
            seat.classList.remove('active');
          } else {
            seat.dataset.active = "true";
            seat.classList.add('active');
          }
        });
      });
      
      return rowContainer;
    }
    
    // Create a subdivision where you can specify the number of rows
    function createSubdivision() {
      const subdivision = document.createElement('div');
      subdivision.classList.add('subdivision');
      
      // Subdivision header with name input
      const header = document.createElement('div');
      header.classList.add('header');
      const subDivNameInput = document.createElement('input');
      subDivNameInput.type = "text";
      subDivNameInput.placeholder = "Subdivision Name";
      header.appendChild(subDivNameInput);
      subdivision.appendChild(header);
      
      // Row configuration panel: set number of rows for this subdivision
      const rowConfigDiv = document.createElement('div');
      rowConfigDiv.classList.add('row-config');
      const rowsLabel = document.createElement('span');
      rowsLabel.textContent = "Number of Rows:";
      rowConfigDiv.appendChild(rowsLabel);
      
      const rowCountInput = document.createElement('input');
      rowCountInput.type = "number";
      rowCountInput.min = "1";
      rowCountInput.value = "1"; // default to 1 row
      rowCountInput.style.width = "50px";
      rowConfigDiv.appendChild(rowCountInput);
      
      const generateRowsBtn = document.createElement('button');
      generateRowsBtn.textContent = "Generate Rows";
      rowConfigDiv.appendChild(generateRowsBtn);
      
      subdivision.appendChild(rowConfigDiv);
      
      // Container to hold the row elements
      const rowsContainer = document.createElement('div');
      rowsContainer.classList.add('rows-container');
      subdivision.appendChild(rowsContainer);
      
      generateRowsBtn.addEventListener('click', function() {
        const numRows = parseInt(rowCountInput.value);
        if (isNaN(numRows) || numRows < 1) {
          alert("Invalid number of rows.");
          return;
        }
        // Clear any existing rows
        rowsContainer.innerHTML = "";
        // Create each row with a default of 10 chairs (modifiable later)
        for (let i = 0; i < numRows; i++) {
          const defaultSeatCount = 10;
          const row = createRow(defaultSeatCount);
          rowsContainer.appendChild(row);
        }
      });
      
      return subdivision;
    }
    
    // Create a division container that can hold subdivisions
    function createDivision() {
      const division = document.createElement('div');
      division.classList.add('division');
      
      // Division header with name input and a button to add a subdivision
      const header = document.createElement('div');
      header.classList.add('header');
      
      const divNameInput = document.createElement('input');
      divNameInput.type = "text";
      divNameInput.placeholder = "Division Name";
      header.appendChild(divNameInput);
      
      const addSubdivBtn = document.createElement('button');
      addSubdivBtn.textContent = "Add Subdivision";
      addSubdivBtn.addEventListener('click', () => {
        const subdivision = createSubdivision();
        division.appendChild(subdivision);
      });
      header.appendChild(addSubdivBtn);
      
      division.appendChild(header);
      return division;
    }
    
    // Global control: Add new Division to the layout editor
    document.getElementById('add-division-btn').addEventListener('click', () => {
      const division = createDivision();
      document.getElementById('layout-editor').appendChild(division);
    });
    
    // Finalize Layout: Gather the hierarchy data, generate a PNG, save both to localStorage,
    // and then redirect to the group page.
    document.getElementById('finalize-btn').addEventListener('click', () => {
      const layoutData = [];
      // Traverse each division
      document.querySelectorAll('.division').forEach(divisionElem => {
        const divisionName = divisionElem.querySelector('input[type="text"]').value || "Unnamed Division";
        const divisionData = { name: divisionName, subdivisions: [] };
        
        // Traverse each subdivision in this division
        divisionElem.querySelectorAll('.subdivision').forEach(subdivisionElem => {
          const subdivisionName = subdivisionElem.querySelector('input[type="text"]').value || "Unnamed Subdivision";
          const subdivisionData = { name: subdivisionName, rows: [] };
          
          // Traverse each row in this subdivision
          subdivisionElem.querySelectorAll('.seat-row-container').forEach(rowContainer => {
            const rowDiv = rowContainer.querySelector('.seat-row');
            const rowData = [];
            rowDiv.querySelectorAll('.seat').forEach(seatElem => {
              rowData.push(seatElem.dataset.active === "true");
            });
            subdivisionData.rows.push(rowData);
          });
          divisionData.subdivisions.push(subdivisionData);
        });
        layoutData.push(divisionData);
      });
      
      // Save layout data to localStorage
      localStorage.setItem('auditoriumRoomLayout', JSON.stringify(layoutData));
      
      // Use html2canvas to capture the layout editor as a PNG image
      html2canvas(document.getElementById('layout-editor')).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        // Save the PNG data URL in localStorage for later use (for example, on the group page)
        localStorage.setItem('auditoriumRoomLayoutImage', imgData);
        // Inform the user and then redirect to the group page
        alert("Layout finalized and PNG image saved! Redirecting to Group page...");
        window.location.href = "groups.html";
      }).catch(err => {
        console.error("Error generating image:", err);
        alert("Layout saved, but failed to generate PNG image.");
      });
    });
  </script>
</body>
</html>
