<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Auditorium Layout Editor (Dark Mode)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #121212;
      color: #e0e0e0;
    }
    /* File upload controls */
    #upload-controls {
      margin-bottom: 20px;
    }
    input[type="file"] {
      background-color: #333;
      color: #e0e0e0;
      border: 1px solid #555;
      padding: 5px;
    }
    /* Background container */
    #background-container {
      position: relative;
      width: 800px;
      height: 600px;
      border: 1px solid #555;
      margin-bottom: 20px;
      background-size: cover;
      background-position: center;
    }
    /* Overlay for layout elements */
    #layout-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none; /* Child elements will enable interaction */
    }
    /* Division styling */
    .division {
      position: absolute;
      border: 2px solid #888;
      background-color: rgba(30, 30, 30, 0.8);
      pointer-events: auto;
      box-sizing: border-box;
    }
    .division .header {
      background-color: #333;
      cursor: move;
      padding: 2px;
      font-size: 14px;
    }
    .division .controls {
      font-size: 12px;
      padding: 2px;
    }
    /* Subdivision styling */
    .subdivision {
      position: relative;
      border: 1px dashed #0077cc;
      background-color: rgba(30, 30, 30, 0.8);
      margin: 5px;
      pointer-events: auto;
      box-sizing: border-box;
    }
    .subdivision .header {
      background-color: #444;
      cursor: move;
      padding: 2px;
      font-size: 13px;
    }
    .subdivision .controls {
      font-size: 11px;
      padding: 2px;
    }
    /* Button and input styling */
    button {
      background-color: #333;
      color: #e0e0e0;
      border: 1px solid #555;
      padding: 2px 5px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 2px;
    }
    input[type="text"],
    input[type="number"] {
      background-color: #333;
      border: 1px solid #555;
      color: #e0e0e0;
      padding: 2px;
      font-size: 12px;
      width: 60px;
      margin-left: 2px;
    }
  </style>
</head>
<body>
  <h1>Auditorium Layout Editor (Dark Mode)</h1>
  <p>
    Upload a topâ€‘down image of your room. Then, add divisions and subdivisions that you can resize, rotate, and reposition over the image.
  </p>
  
  <!-- Upload Background Image -->
  <div id="upload-controls">
    <label for="bg-upload">Upload Background Image:</label>
    <input type="file" id="bg-upload" accept="image/*">
  </div>
  
  <!-- Background Container with Overlay -->
  <div id="background-container">
    <!-- The background image will be set via CSS -->
    <div id="layout-overlay"></div>
  </div>
  
  <!-- Global Controls -->
  <button id="add-division-btn">Add Division</button>
  <button id="finalize-btn" style="margin-top:20px;">Finalize Layout &amp; Proceed to Groups</button>
  
  <script>
    // Handle background image upload
    document.getElementById('bg-upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        const dataURL = event.target.result;
        document.getElementById('background-container').style.backgroundImage = 'url(' + dataURL + ')';
        localStorage.setItem('auditoriumBackgroundImage', dataURL);
      };
      reader.readAsDataURL(file);
    });
    
    const overlay = document.getElementById('layout-overlay');
    
    // Simple dragging support
    function makeDraggable(el) {
      let startX = 0, startY = 0, initialLeft = 0, initialTop = 0;
      const header = el.querySelector('.header');
      header.addEventListener('mousedown', dragStart);
      
      function dragStart(e) {
        e.preventDefault();
        startX = e.clientX;
        startY = e.clientY;
        initialLeft = parseFloat(el.style.left) || 0;
        initialTop = parseFloat(el.style.top) || 0;
        document.addEventListener('mousemove', dragMove);
        document.addEventListener('mouseup', dragEnd);
      }
      
      function dragMove(e) {
        e.preventDefault();
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        el.style.left = (initialLeft + dx) + "px";
        el.style.top = (initialTop + dy) + "px";
      }
      
      function dragEnd(e) {
        document.removeEventListener('mousemove', dragMove);
        document.removeEventListener('mouseup', dragEnd);
      }
    }
    
    let divisionCount = 0;
    
    // Create a Division with controls for size and rotation
    function createDivision() {
      const div = document.createElement('div');
      div.classList.add('division');
      div.style.width = "200px";
      div.style.height = "150px";
      div.style.left = (20 + divisionCount * 30) + "px";
      div.style.top = (20 + divisionCount * 30) + "px";
      div.style.transform = "rotate(0deg)";
      
      // Header with division name
      const header = document.createElement('div');
      header.classList.add('header');
      header.textContent = "Division " + (divisionCount + 1);
      div.appendChild(header);
      
      // Controls for width, height, and rotation plus a button to add a subdivision
      const controls = document.createElement('div');
      controls.classList.add('controls');
      controls.innerHTML = `
        Width: <input type="number" class="width-input" value="200"> 
        Height: <input type="number" class="height-input" value="150"> 
        Rotation: <input type="number" class="rotation-input" value="0"> 
        <button class="apply-btn">Apply</button>
        <button class="add-subdiv-btn">Add Subdivision</button>
      `;
      div.appendChild(controls);
      
      controls.querySelector('.apply-btn').addEventListener('click', () => {
        const width = controls.querySelector('.width-input').value;
        const height = controls.querySelector('.height-input').value;
        const rotation = controls.querySelector('.rotation-input').value;
        div.style.width = width + "px";
        div.style.height = height + "px";
        div.style.transform = `rotate(${rotation}deg)`;
      });
      
      controls.querySelector('.add-subdiv-btn').addEventListener('click', () => {
        const subdiv = createSubdivision();
        div.appendChild(subdiv);
      });
      
      makeDraggable(div);
      divisionCount++;
      return div;
    }
    
    // Create a Subdivision with its own size/rotation controls
    function createSubdivision() {
      const subdiv = document.createElement('div');
      subdiv.classList.add('subdivision');
      subdiv.style.width = "150px";
      subdiv.style.height = "100px";
      subdiv.style.transform = "rotate(0deg)";
      
      const header = document.createElement('div');
      header.classList.add('header');
      header.textContent = "Subdivision";
      subdiv.appendChild(header);
      
      const controls = document.createElement('div');
      controls.classList.add('controls');
      controls.innerHTML = `
        Width: <input type="number" class="width-input" value="150"> 
        Height: <input type="number" class="height-input" value="100"> 
        Rotation: <input type="number" class="rotation-input" value="0"> 
        <button class="apply-btn">Apply</button>
      `;
      subdiv.appendChild(controls);
      
      controls.querySelector('.apply-btn').addEventListener('click', () => {
        const width = controls.querySelector('.width-input').value;
        const height = controls.querySelector('.height-input').value;
        const rotation = controls.querySelector('.rotation-input').value;
        subdiv.style.width = width + "px";
        subdiv.style.height = height + "px";
        subdiv.style.transform = `rotate(${rotation}deg)`;
      });
      
      makeDraggable(subdiv);
      
      // (Optional: further controls can be added here for rows/seats.)
      
      return subdiv;
    }
    
    // Global button to add a new Division
    document.getElementById('add-division-btn').addEventListener('click', () => {
      const division = createDivision();
      overlay.appendChild(division);
    });
    
    // Finalize Layout: collect layout data and save to localStorage, then redirect
    document.getElementById('finalize-btn').addEventListener('click', () => {
      const layoutData = [];
      overlay.querySelectorAll('.division').forEach(div => {
        const divRect = div.getBoundingClientRect();
        const overlayRect = overlay.getBoundingClientRect();
        const divisionData = {
          name: div.querySelector('.header').textContent,
          x: divRect.left - overlayRect.left,
          y: divRect.top - overlayRect.top,
          width: div.offsetWidth,
          height: div.offsetHeight,
          rotation: parseFloat(div.style.transform.replace('rotate(', '').replace('deg)', '')) || 0,
          subdivisions: []
        };
        div.querySelectorAll('.subdivision').forEach(subdiv => {
          const sRect = subdiv.getBoundingClientRect();
          const subdivData = {
            name: subdiv.querySelector('.header').textContent,
            x: sRect.left - divRect.left,
            y: sRect.top - divRect.top,
            width: subdiv.offsetWidth,
            height: subdiv.offsetHeight,
            rotation: parseFloat(subdiv.style.transform.replace('rotate(', '').replace('deg)', '')) || 0
          };
          divisionData.subdivisions.push(subdivData);
        });
        layoutData.push(divisionData);
      });
      
      localStorage.setItem('auditoriumRoomLayout', JSON.stringify(layoutData));
      alert("Layout finalized and saved! Redirecting to Groups page...");
      window.location.href = "groups.html";
    });
  </script>
</body>
</html>
