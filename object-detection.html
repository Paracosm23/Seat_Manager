<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>COCO-SSD Object Detection</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #121212;
        color: #e0e0e0;
        text-align: center;
        padding: 20px;
      }
      #canvas {
        border: 1px solid #555;
        margin-top: 20px;
      }
      input[type="file"] {
        margin-top: 20px;
      }
      #status {
        margin-top: 10px;
      }
    </style>
    <!-- Load TensorFlow.js and COCO-SSD from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  </head>
  <body>
    <h1>COCO-SSD Object Detection</h1>
    <p>Upload an image to detect objects.</p>
    <input type="file" id="image-upload" accept="image/*">
    <p id="status">Loading model, please wait...</p>
    <canvas id="canvas"></canvas>
    
    <script>
      let model;
      const statusEl = document.getElementById('status');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      let pendingImage = null; // if an image is uploaded before model loads

      // Load the COCO-SSD model
      cocoSsd.load().then(loadedModel => {
        model = loadedModel;
        statusEl.textContent = "Model loaded. Please upload an image.";
        if (pendingImage) {
          processImage(pendingImage);
          pendingImage = null;
        }
      }).catch(err => {
        statusEl.textContent = "Error loading model.";
        console.error(err);
      });

      // Process the image: draw it on the canvas and run detection
      function processImage(img) {
        // Set canvas size to match image
        canvas.width = img.width;
        canvas.height = img.height;
        // Draw the image
        ctx.drawImage(img, 0, 0);
        // Run object detection
        model.detect(img).then(predictions => {
          predictions.forEach(prediction => {
            const [x, y, width, height] = prediction.bbox;
            ctx.strokeStyle = "red";
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, width, height);
            ctx.fillStyle = "red";
            ctx.font = "16px Arial";
            const text = `${prediction.class} (${Math.round(prediction.score * 100)}%)`;
            ctx.fillText(text, x, y > 10 ? y - 5 : 10);
          });
          statusEl.textContent = "Detection complete.";
        }).catch(err => {
          console.error("Detection error:", err);
          statusEl.textContent = "Error during detection.";
        });
      }

      // Handle file upload
      document.getElementById('image-upload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            if (model) {
              processImage(img);
            } else {
              statusEl.textContent = "Model not loaded yet. Processing image once ready...";
              pendingImage = img;
            }
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });
    </script>
  </body>
</html>
